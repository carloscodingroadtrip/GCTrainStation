$(document).ready(function () {
    $("input").focus(function(){
        $(this).css("background-color", "#1A3A3A");
        $(this).css("color", "#fff");
    });
    $("input").blur(function(){
        $(this).css("background-color", "#E77200");
    });
    var data,randomID;
    var config = {
        apiKey: "AIzaSyAG0wfCLZpe-EMXcbg6ZkcnHXuOf9j2G8o",
        authDomain: "trainwreck-622d8.firebaseapp.com",
        databaseURL: "https://trainwreck-622d8.firebaseio.com",
        projectId: "trainwreck-622d8",
        storageBucket: "trainwreck-622d8.appspot.com",
        messagingSenderId: "824399186719"
    };
    //Initialize the database
    firebase.initializeApp(config);
    // Create a variable to reference the database
    var db = firebase.database().ref('Trains');
    var myTrainObj = {
        name: null,
        destination: null,
        frequecy: 0,
        firstTrain: null,
        ID: 102030409,
    };

    //-------- DATABASE ------------------------------
    db.on("child_added", function (childSnapshot) {
        data = Object.values(childSnapshot.val());
        console.log(data);
        var key = childSnapshot.key;
        console.log(key)
        let [destination, firstTrain, frequency, name] = data;

        var delete$ = $("<td dataKey= '" + key + "' class = 'special_column text-center delete'>").html('<i class="text-danger fas fa-trash-alt"></i>');
        var edit$ = $("<td dataKey= '" + key + "' class = 'special_column text-center edit'>").html('<i class="text-info fas fa-edit"></i>');
        var name$ = $("<td>").text(name);
        var destination$ = $("<td>").text(destination);
        var frequency$ = $("<td>").text(frequency);
        var nextArrival$ = $("<td>").text(firstTrain);
        var tBody = $("tbody");
        var tRow = $("<tr>");
        // // Append the newly created table data to the table row
        tRow.prepend(delete$, edit$, name$, destination$, frequency$, nextArrival$);
        // // Append the table row to the table body
        tBody.prepend(tRow);
        return childSnapshot;
        // Generate a reference to a new location and add some data using push()
        // var newPostRef = postsRef.push();

        // // Get the unique key generated by push()
        // var postId = newPostRef.key;
        // Then include Firebase error logging
    },
        function (errorObject) {
            // In case of error this will print the error
            console.log("The read failed: " + errorObject.code);
    });

    function isEmpty(str) {
        return (!str || 0 === str.length);
    }

    $('#trainNameInput').bind('keypress', testInput);
    $('#trainDestInput').bind('keypress', testInput);

    $('#addTrainBtn').on('click', function (e) {
        // e.preventDefault();
        // Capture user inputs and store them into variables
        var trainName = $("#trainNameInput").val().trim();
        var trainDest = $("#trainDestInput").val().trim();
        var firstTrainInput = $("#firstTrainInput").val().trim();
        var frequency = $("#frequencyInput").val().trim();
        if (isEmpty(trainName) || isEmpty(trainDest) || parseInt(frequency) >180) {
            document.getElementById("freqerror").innerHTML = "Error, do not exceed 180 minutes";
            $("#frequencyInput").focus().addClass('invalid');
            alert(`All fields are required.

For the First Train Time, you will need to specify AM or PM as well.

Frequency cannot exceed 180 minutes.            `);

        } else {
            $("#addTrainBtn").removeClass('invalid');

            var momentFirstTrain =  moment(firstTrainInput, "HH:mm").subtract(1, "years");
            console.log(momentFirstTrain);

            // Current Time
            var currentTime = moment();
            console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));

            // Difference between the times
            var diffTime = moment().diff(moment(momentFirstTrain), "minutes");
            console.log("DIFFERENCE IN TIME: " + diffTime);

            // Time apart (remainder)
            var tRemainder = diffTime % frequency;
            console.log('Time apart : ' + tRemainder);

            // Minute Until Train
            var tMinutesTillTrain = frequency - tRemainder;
            console.log("MINUTES TILL TRAIN: " + tMinutesTillTrain);

            // Next Train
            var nextTrain = moment().add(tMinutesTillTrain, "minutes");
            console.log("ARRIVAL TIME: " + moment(nextTrain).format("hh:mm"));

            myTrainObj.name = trainName;
            myTrainObj.destination = trainDest;
            myTrainObj.frequecy = frequency;
            myTrainObj.firstTrain = firstTrainInput;
            myTrainObj.ID = randomID;
            console.log(myTrainObj);
        }

        //Push to the database
        //db.push(myTrain);
    });

    //Numeric field validation agains COPY/PASTE content
    function handlePaste(e) {
        var clipboardData, pastedData;
        // Get pasted data via clipboard API
        clipboardData = e.clipboardData || window.clipboardData;
        pastedData = clipboardData.getData('Text').toUpperCase();
        if (pastedData.indexOf('E') > -1) {
            //alert('found an E');
            e.stopPropagation();
            e.preventDefault();
        }
    }

    // (function FilterInput(event) {
    //     var keyCode = ('which' in event) ? event.which : event.keyCode;
    //     isNotWanted = (keyCode == 109 || keyCode == 189 || keyCode == 69 || keyCode == 101 || keyCode == 190);
    //     return !isNotWanted;
    //     e.stopPropagation();
    //     e.preventDefault();
    // })();


    //remove data from firbase
    $(document).on("click", ".remove", function () {
        // debugger;
        var db = firebase.database();
        var ref = db.ref('trainSchedule');
        var key = $(this).attr(dataKey);
        ref.child(key).remove();
    });

    //Text input fields validation - TO ACCEPT ONLY ALPHAs
    function testInput(event) {
        var value = String.fromCharCode(event.which);
        var pattern = new RegExp(/[a-zåäö ]/i);
        return pattern.test(value);
    }
});